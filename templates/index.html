<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>RoadForge – Workouts in Sekunden</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-1">Individuelle Rad-Workouts in Sekunden – sofort fahrbar in Zwift &amp; Co.</h1>
    <p class="text-slate-600 mb-6">Dauer & Fokus wählen → Generate → Download als .zwo oder .mrc.</p>

    <form class="flex flex-wrap gap-3 items-end"
          hx-post="/preview" hx-trigger="submit"
          hx-target="#preview" hx-swap="innerHTML">
      <label class="block">
        <span class="text-sm">Dauer (Min)</span>
        <select name="duration_min" class="px-3 py-2 border rounded">
          <option>30</option><option selected>45</option><option>60</option><option>75</option><option>90</option>
        </select>
      </label>

      <label class="block">
        <span class="text-sm">Fokus</span>
        <select name="focus" class="px-3 py-2 border rounded">
          <option>Endurance</option>
          <option>SweetSpot</option>
          <option>Threshold</option>
          <option selected>VO2</option>
        </select>
      </label>

      <label class="inline-flex items-center gap-2">
        <input type="checkbox" name="vary" class="w-4 h-4">
        <span class="text-sm">Variante</span>
      </label>

      <button class="px-4 py-2 bg-blue-600 text-white rounded">Workout erstellen</button>
    </form>

    <div class="mt-4 flex gap-3">
      <a id="btn-zwo" href="#" class="px-3 py-2 bg-slate-900 text-white rounded">Download .zwo</a>
      <a id="btn-mrc" href="#" class="px-3 py-2 bg-slate-700 text-white rounded">Download .mrc</a>
    </div>

    <div id="preview" class="mt-6 text-sm text-slate-800"></div>
  </div>

  <script>
    function buildDownloadUrls() {
      const duration = document.querySelector('select[name="duration_min"]').value;
      const focus = document.querySelector('select[name="focus"]').value;
      const vary = document.querySelector('input[name="vary"]').checked ? '1' : '0';
      return {
        zwo: `/download?fmt=zwo&duration_min=${duration}&focus=${encodeURIComponent(focus)}&vary=${vary}`,
        mrc: `/download?fmt=mrc&duration_min=${duration}&focus=${encodeURIComponent(focus)}&vary=${vary}`
      };
    }

    function updateDownloadLinks() {
      const urls = buildDownloadUrls();
      const z = document.getElementById('btn-zwo');
      const m = document.getElementById('btn-mrc');
      if (z) z.href = urls.zwo;
      if (m) m.href = urls.mrc;
    }

    document.addEventListener('DOMContentLoaded', updateDownloadLinks);
    document.querySelector('form').addEventListener('change', updateDownloadLinks);
    document.querySelector('form').addEventListener('input', updateDownloadLinks);

    document.body.addEventListener('htmx:afterRequest', (e) => {
      if (e.detail.path !== '/preview') return;
      const data = e.detail.xhr.response ? JSON.parse(e.detail.xhr.response) : null;
      if (!data) return;
      const total = data.steps.reduce((s,x)=>s+x.d,0);

      let bars = '<div class="flex h-20 rounded overflow-hidden ring-1 ring-slate-200">';
      data.steps.forEach(s=>{
        const w = (s.d/total*100).toFixed(2)+'%';
        const pct = s.pct;
        const color = pct>=1.10 ? 'bg-red-400'
                    : pct>=0.95 ? 'bg-orange-400'
                    : pct>=0.88 ? 'bg-amber-400'
                    : pct>=0.70 ? 'bg-lime-400'
                    : 'bg-green-400';
        bars += `<div class="${color}" style="width:${w}" title="${Math.round(pct*100)}% · ${s.d}s ${s.note||''}"></div>`;
      });
      bars += '</div>';

      document.getElementById('preview').innerHTML = `
        <div class="space-y-3">
          ${bars}
          <div>Name: <b>${data.name}</b> · IF <b>${data.if}</b> · TSS <b>${data.tss}</b></div>
        </div>`;

      updateDownloadLinks();
    });
  </script>
</body>
</html>
